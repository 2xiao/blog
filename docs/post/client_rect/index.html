<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://2xiao.github.io/blog/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://2xiao.github.io/blog/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://2xiao.github.io/blog/css/github.min.css' />
    <link rel="stylesheet" href='https://2xiao.github.io/blog/css/github-style.css' />
    <link rel="stylesheet" href='https://2xiao.github.io/blog/css/light.css' />
    <link rel="stylesheet" href='https://2xiao.github.io/blog/css/dark.css' />
    <link rel="stylesheet" href='https://2xiao.github.io/blog/css/syntax.css' />
    <title>如何获取元素在页面中的绝对位置？ - 二小の博客</title>
    
    <link rel="icon" type="image/x-icon" href='https://2xiao.github.io/blog/images/favicon.ico'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="你听说过getBoundingClientRect吗？
" />
<meta name="keywords"
  content='' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://2xiao.github.io/blog/post/client_rect/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="如何获取元素在页面中的绝对位置？ - 二小の博客" />
<meta name="twitter:description"
  content="你听说过getBoundingClientRect吗？
" />
<meta name="twitter:site" content="https://2xiao.github.io/blog" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://2xiao.github.io/blog">


<meta property="og:type" content="article" />
<meta property="og:title" content="如何获取元素在页面中的绝对位置？ - 二小の博客">
<meta property="og:description"
  content="你听说过getBoundingClientRect吗？
" />
<meta property="og:url" content="https://2xiao.github.io/blog/post/client_rect/" />
<meta property="og:site_name" content="如何获取元素在页面中的绝对位置？" />
<meta property="og:image"
  content="https://2xiao.github.io/blog">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2018-07-16 11:00:19 &#43;0800 CST" />










</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://2xiao.github.io/blog">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://2xiao.github.io/blog">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://2xiao.github.io/blog">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://2xiao.github.io/blog">
                  <img class=" avatar-user"
                    src="https://2xiao.github.io/blog/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://2xiao.github.io/blog">二小</a></span><span
                    class="path-divider">/</span><strong class="css-truncate-target mr-1" style="max-width: 410px"><a
                      href="https://2xiao.github.io/blog/post/client_rect/">如何获取元素在页面中的绝对位置？</a></strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Mon, 16 Jul 2018 11:00:19 &#43;0800"
                    class="no-wrap">
                    Mon, 16 Jul 2018 11:00:19 &#43;0800</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Wed, 17 Mar 2021 11:57:16 &#43;0800"
                    class="no-wrap">
                    Wed, 17 Mar 2021 11:57:16 &#43;0800</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div class="file-header d-flex flex-md-items-center flex-items-start">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    1681 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/blog/tags/javascript">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      JavaScript
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5">
                <article class="markdown-body entry-content container-lg"><p>你听说过getBoundingClientRect吗？</p>
<h3 id="从一个坑爹的需求说开去">从一个坑爹的需求说开去</h3>
<p>上周产品小哥哥丢过来一个需求，名曰：沉浸式视频体验，大致内容是一个页面里有几十个视频，用户点击其中一个视频时，该视频自动滑动到屏幕可视区域的顶部开始播放，并暂停其他视频，该视频滑出屏幕可视区域之后要自动暂停。</p>
<p>这个需求有两个关键的技术点：</p>
<ol>
<li>如何将视频滑动到屏幕可视区域的顶部</li>
<li>如何判断视频滑出了屏幕可视区域</li>
</ol>
<p>其实这两个技术点有一个共同点，就是需求计算出元素在页面中的绝对位置，也就是指该元素的左上角相对于整张网页左上角的坐标，有两种方法可以计算得到：</p>
<h4 id="1递归">1.递归</h4>
<p>利用<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/offsetTop">offsetTop</a>和<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/offsetLeft">offsetLeft</a>可以取到当前元素左上角相对于其<code>HTMLElement.offsetParent</code>节点的左边界偏移的像素值，然后再利用<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLElement/offsetParent">HTMLElement.offsetParent</a>
可以得到一个指向最近的包含该元素的定位元素。</p>
<p>如果没有定位的元素，则<code>offsetParent</code>为最近的<code>table</code>,<code>table cell</code>或根元素（标准模式下为<code>html</code>；<code>quirks</code>模式下为<code>body</code>）。</p>
<p>利用以上三个属性，写一个递归函数就可以得到当前元素在页面中的绝对位置了：</p>
<pre><code>const getElementLeft = element =&gt; {
	let actualLeft = element.offsetLeft;
	let current = element.offsetParent;
	while (current !== null){
		actualLeft += current.offsetLeft;
		current = current.offsetParent;
	}
	return actualLeft;
}
const getElementTop = element =&gt; {
	let actualTop = element.offsetTop;
	let current = element.offsetParent;
	while (current !== null){
		actualTop += current.offsetTop;
		current = current.offsetParent;
	}
	return actualTop;
}

</code></pre><p>注意：由于在表格和iframe中，<code>offsetParent</code>对象未必等于父容器，所以上面的函数对于表格和iframe中的元素不适用。</p>
<h4 id="2-你听说过getboundingclientrect吗">2. 你听说过getBoundingClientRect吗？</h4>
<p><code>object.getBoundingClientRect()</code>的返回值包含了一组只读属性，包括该元素相对于视口左上角位置的<code>left</code>、<code>top</code>、<code>right</code>和<code>bottom</code>，以及元素的<code>width</code>和<code>height</code>，单位为像素，具体含义可参见下图：</p>
<p><img src="http://mat1.gtimg.com/www/js/news/wemeet/rect.png" alt=""></p>
<p>从上图可以看出，<code>getBoundingClientRect</code>得到的值是相对于视口的，而不是绝对的，当视口区域或其他可滚动元素内发生滚动操作时，top和left属性值就会随之立即发生变化。</p>
<p>要获得相对于整个网页左上角定位的属性值，只要给top、left属性值加上当前的滚动位置（通过<code>window.scrollX</code>和<code>window.scrollY</code>），这样就可以获取与当前的滚动位置无关的值。</p>
<h3 id="如何将视频滑动到屏幕可视区域的顶部">如何将视频滑动到屏幕可视区域的顶部？</h3>
<p>考虑到<code>getBoundingClientRect</code>的兼容性较好，且算法复杂度较低，最终我采用了<code>getBoundingClientRect</code>方法来实现“将视频滑动到屏幕可视区域的顶部”的功能，使用<code>window.scroll</code>来实现页面滚动，使用<code>setTimeout</code>增加滚动时的动画，具体实现滚动的函数如下：</p>
<pre><code>const autoScroll = (offsetTop, needScrollTop, hasScrollTop) =&gt; {
	let _needScrollTop = needScrollTop; // 本次递归时，离终点的距离
	let _hasScrollTop = hasScrollTop; // 本次递归时，已经移动的距离总和
	const speed = 10;
	setTimeout(() =&gt; {
		const dist = needScrollTop &gt; 0
			? Math.max(Math.ceil(needScrollTop / speed), 5)
			: Math.min(Math.ceil(needScrollTop / speed), -5);
		_needScrollTop -= dist;
		_hasScrollTop += dist;
		window.scroll(0, offsetTop + _hasScrollTop);
		// 如果移动幅度小于十个像素，直接移动，否则递归调用，实现动画效果
		if (_needScrollTop &gt; speed || _needScrollTop &lt; -speed) {
			this.__onScroll(offsetTop, _needScrollTop, _hasScrollTop);
		} else {
			window.scroll(0, offsetTop + _hasScrollTop + _needScrollTop);
		}
	}, 1);
}

const rect = element.getBoundingClientRect();

const offsetTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || window.screenY;

autoScroll(offsetTop, rect.top, 0);

</code></pre><h3 id="如何判断视频滑出了屏幕可视区域">如何判断视频滑出了屏幕可视区域？</h3>
<p>利用<code>getBoundingClientRect</code>的返回值同样可以判断元素在屏幕可视区域的曝光和滑出，通过监听页面的滚动事件，在滚动结束时，触发<code>checkLeave</code>和<code>checkExpose</code>函数，具体代码如下：</p>
<pre><code>// 检测滑出可视区域
checkLeave() {
	const element = document.querySelector(`[data-action-id=&quot;${this.__domId}&quot;]`);
	if (!element) {
		console.error(`Action: element [data-action-id=&quot;${this.__domId}&quot;] not found`);
		return;
	}
	const { top, bottom, left, right } = element.getBoundingClientRect();
	if ((top &gt; getWindowHeight() || bottom &lt; 0
		|| left &gt; getWindowWidth() || right &lt; 0)) {
		this.onLeave(); //onLeave函数中实现具体业务逻辑
	}
}

// 检测真实曝光
checkExpose() {
	const element = document.querySelector(`[data-action-id=&quot;${this.__domId}&quot;]`);
	if (!element) {
		console.error(`Action: element [data-action-id=&quot;${this.__domId}&quot;] not found`);
		return;
	}
	const { top, bottom, left, right } = element.getBoundingClientRect();
	if (Math.max(0, top) &lt;= Math.min(getWindowHeight(), bottom)
		&amp;&amp; Math.max(0, left) &lt;= Math.min(getWindowWidth(), right)) {
		this.onExpose(); //onExpose函数中实现具体业务逻辑
	}
}

</code></pre><p>可以将这两个事件封装成了一个<code>&lt;Action&gt;</code>组件的两个props参数，使用时只需要在需要的元素外包一层<code>&lt;Action&gt;</code>父元素，并传入特定的回调函数即可。</p>
<p>BTW，多说一句我实现<code>document.querySelector</code>的原理，直接看代码：</p>
<pre><code>render() {
	const { children } = this.props;
	return cloneElement(Children.only(children), {
		'data-action-id': this.__domId,
	});
}

</code></pre><p>以上。</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://2xiao.github.io/blog">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0"><a href='https://github.com/2xiao'>2xiao</a> の blog</li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://2xiao.github.io/blog/js/github-style.js"></script>



</html>